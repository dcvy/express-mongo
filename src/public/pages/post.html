<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BE Panel - React Full Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-new-comment { animation: slideIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const socket = io();

        const parseJwt = (token) => {
            try { return JSON.parse(atob(token.split('.')[1])); } catch { return null; }
        };

        const CommentItem = ({ act }) => {
            const stars = '★'.repeat(act.rating) + '☆'.repeat(5 - act.rating);
            return (
                <div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 text-sm animate-new-comment">
                    <div className="flex justify-between items-center mb-1">
                        <span className="font-bold text-blue-600 text-[10px]">{act.author?.name || 'User'}</span>
                        <span className="text-yellow-500 text-[10px] font-bold">{stars}</span>
                    </div>
                    <p className="text-slate-600 text-[11px] leading-snug">{act.content}</p>
                </div>
            );
        };

        function App() {
            const [posts, setPosts] = useState([]);
            const [categories, setCategories] = useState([]);
            const [user, setUser] = useState({ name: "Đang tải...", id: null });
            const [newPost, setNewPost] = useState({ title: '', content: '', category: '' });
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({ title: '', content: '' });
            
            const token = localStorage.getItem('jwt-token');

            useEffect(() => {
                if (!token) { window.location.href = '/be/login'; return; }
                const decoded = parseJwt(token);
                if (decoded) setUser(decoded);

                fetchData();

                socket.on("NEW_COMMENT_EVENT", (data) => {
                    setPosts(currentPosts => currentPosts.map(p => {
                        if (p._id === data.postId) {
                            return {
                                ...p,
                                averageRating: data.avgRating,
                                activities: [{ author: { name: data.author }, content: data.content, rating: data.rating }, ...(p.activities || [])]
                            };
                        }
                        return p;
                    }));
                });

                return () => socket.off("NEW_COMMENT_EVENT");
            }, []);

            const fetchData = async () => {
                const headers = { 'Authorization': `Bearer ${token}` };
                const [resCat, resPost] = await Promise.all([
                    fetch('/categories', { headers }),
                    fetch('/posts', { headers })
                ]);
                const cats = await resCat.json();
                const pts = await resPost.json();
                
                if (cats.success) setCategories(cats.data);
                if (pts.success) {
                    setPosts(pts.data.reverse());
                    pts.data.forEach(p => socket.emit("join_post", p._id));
                }
            };

            const handleCreatePost = async () => {
                if (!newPost.title || !newPost.content || !newPost.category) return alert("Vui lòng nhập đủ!");
                const res = await fetch('/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(newPost)
                });
                if (res.ok) {
                    setNewPost({ title: '', content: '', category: '' });
                    fetchData();
                }
            };

            const handleDelete = async (id) => {
                if (!confirm("Xóa bài này?")) return;
                await fetch(`/posts/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                setPosts(posts.filter(p => p._id !== id));
            };

            const startEdit = (post) => {
                setEditingId(post._id);
                setEditForm({ title: post.title, content: post.content });
            };

            const saveEdit = async (id) => {
                const res = await fetch(`/posts/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(editForm)
                });
                if (res.ok) {
                    setPosts(posts.map(p => p._id === id ? { ...p, ...editForm } : p));
                    setEditingId(null);
                }
            };

            const sendComment = async (postId) => {
                const content = document.getElementById(`input-${postId}`).value;
                const rating = document.getElementById(`rating-${postId}`).value;
                if (!content) return;

                const res = await fetch('/activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ postId, content, rating: Number(rating) })
                });
                if (res.ok) {
                    document.getElementById(`input-${postId}`).value = '';
                }
            };

            return (
                <div>
                    <nav className="bg-slate-800 text-white shadow-lg px-6 py-4 mb-6">
                        <div className="max-w-5xl mx-auto flex justify-between items-center">
                            <span className="text-2xl font-bold text-blue-400">BE Panel</span>
                            <div className="flex items-center gap-6">
                                <div className="text-right">
                                    <p className="text-[10px] text-slate-400 uppercase">Người dùng</p>
                                    <p className="font-semibold text-blue-300">{user.name}</p>
                                </div>
                                <button onClick={() => { localStorage.removeItem('jwt-token'); window.location.href='/be/login' }} className="bg-slate-700 hover:bg-red-600 px-4 py-2 rounded-lg text-sm transition-all">Đăng xuất</button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

                        <div className="lg:col-span-1">
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 sticky top-6">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center">
                                    <span className="w-2 h-6 bg-blue-600 rounded-full mr-3"></span>Tạo bài mới
                                </h2>
                                <div className="space-y-4">
                                    <input value={newPost.title} onChange={e => setNewPost({...newPost, title: e.target.value})} placeholder="Tiêu đề..." className="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                                    <select value={newPost.category} onChange={e => setNewPost({...newPost, category: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                                        <option value="">Chọn danh mục...</option>
                                        {categories.map(c => <option key={c._id} value={c.name}>{c.name}</option>)}
                                    </select>
                                    <textarea value={newPost.content} onChange={e => setNewPost({...newPost, content: e.target.value})} placeholder="Nội dung..." className="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none" rows="4" />
                                    <button onClick={handleCreatePost} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">ĐĂNG BÀI</button>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-2">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Bảng tin</h2>
                                <button onClick={() => window.location.href='/be/categories'} className="text-sm text-blue-600 font-bold hover:underline">Quản lý danh mục →</button>
                            </div>
                            
                            <div className="space-y-8">
                                {posts.map(post => (
                                    <div key={post._id} className={`bg-white p-6 rounded-3xl shadow-sm border border-slate-100 transition-all ${editingId === post._id ? 'ring-2 ring-blue-100 bg-blue-50/10' : ''}`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase">{post.category?.name || "Chung"}</span>
                                                    <span className="text-yellow-500 font-bold text-xs">⭐ {post.averageRating?.toFixed(1) || 0}</span>
                                                </div>
                                                
                                                {editingId === post._id ? (
                                                    <input value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})} className="w-full text-xl font-bold text-slate-800 border-b-2 border-blue-400 outline-none" />
                                                ) : (
                                                    <h3 className="text-xl font-bold text-slate-800">{post.title}</h3>
                                                )}
                                            </div>

                                            {user.id === (post.author?._id || post.author) && (
                                                <div className="flex gap-2 ml-4">
                                                    {editingId === post._id ? (
                                                        <>
                                                            <button onClick={() => saveEdit(post._id)} className="bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-lg">LƯU</button>
                                                            <button onClick={() => setEditingId(null)} className="text-slate-400 text-[10px] font-bold px-2 py-1">HỦY</button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <button onClick={() => startEdit(post)} className="text-blue-500 text-[10px] font-bold border border-blue-100 px-2 py-1 rounded-lg">SỬA</button>
                                                            <button onClick={() => handleDelete(post._id)} className="text-red-400 text-[10px] font-bold border border-red-100 px-2 py-1 rounded-lg">XÓA</button>
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>

                                        {editingId === post._id ? (
                                            <textarea value={editForm.content} onChange={e => setEditForm({...editForm, content: e.target.value})} className="w-full mt-4 text-slate-600 border-2 border-blue-100 rounded-xl p-2 outline-none" rows="3" />
                                        ) : (
                                            <p className="text-slate-600 mb-6">{post.content}</p>
                                        )}

                                        {/* PHẦN BÌNH LUẬN */}
                                        <div className="mt-4 pt-4 border-t border-slate-50">
                                            <h4 className="text-[10px] font-black text-slate-400 uppercase mb-3">Hoạt động ({post.activities?.length || 0})</h4>
                                            <div className="space-y-2 mb-4 max-h-60 overflow-y-auto">
                                                {post.activities?.length > 0 ? 
                                                    post.activities.map((act, i) => <CommentItem key={i} act={act} />) 
                                                    : <p className="text-[10px] text-slate-300 italic text-center">Chưa có bình luận.</p>
                                                }
                                            </div>
                                            
                                            <div className="bg-slate-50 p-3 rounded-2xl flex flex-col gap-2">
                                                <div className="flex justify-between items-center">
                                                    <select id={`rating-${post._id}`} className="text-[10px] font-bold border-none bg-white rounded-lg px-2 py-1">
                                                        <option value="5">5 ★ Rất tốt</option><option value="4">4 ★ Tốt</option><option value="3">3 ★ Trung bình</option><option value="2">2 ★ Kém</option><option value="3">3 ★ Rất kém</option>
                                                    </select>
                                                    <button onClick={() => sendComment(post._id)} className="text-[10px] bg-blue-600 text-white px-4 py-1.5 rounded-xl font-bold">Gửi</button>
                                                </div>
                                                <input id={`input-${post._id}`} type="text" placeholder="Để lại ý kiến..." className="w-full px-3 py-2 text-xs border-none rounded-xl outline-none focus:ring-2 focus:ring-blue-400" />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>